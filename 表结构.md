以下是修改后的完整表结构.md文档内容：

# 综合优化后的数据库设计方案 (实际实现版本)

------

## **总体设计原则**

1. **高内聚低耦合**：将频繁变更字段与核心属性分离
2. **历史追溯性**：完整记录资产全生命周期轨迹
3. **查询性能优先**：关键字段建立复合索引
4. **扩展性预留**：使用JSON字段应对未来字段变化
5. **导入去重化**：使用数据指纹和行哈希值防止重复导入

------

## **核心表结构设计**

### **1. 资产主表 (asset_master)**

| 字段名             | 类型            | 约束/说明                                                    |
| ------------------ | --------------- | ------------------------------------------------------------ |
| asset_id           | BIGINT UNSIGNED | 主键，自增                                                   |
| asset_uuid         | CHAR(36)        | 业务唯一标识，生成规则: CONCAT('AST', DATE_FORMAT(NOW(), '%Y%m%d'), '-', UUID()) |
| asset_no           | VARCHAR(32)     | UNIQUE NOT NULL，资产编号规则: 分类码+部门码+年月+序列号     |
| asset_name         | VARCHAR(255)    | NOT NULL                                                     |
| current_status     | VARCHAR(20)     | NOT NULL，当前状态（IN_USE:使用中/INVENTORY:库存中/MAINTENANCE:维修中/RETIRED:已报废） |
| category_hierarchy | JSON            | NOT NULL，存储分类路径 {"l1":1,"l2":3,"l3":5} - 值为分类ID   |
| space_id           | BIGINT UNSIGNED | 当前空间位置（外键，关联space_timeline表的space_id）         |
| warranty_id        | BIGINT UNSIGNED | 当前有效维保（外键，关联warranty_contract表的warranty_id）   |
| data_fingerprint   | CHAR(64)        | 数据指纹（SHA256哈希值）                                     |
| import_batch       | VARCHAR(32)     | 导入批次标识，用于批次追踪                                   |
| excel_row_hash     | CHAR(64)        | Excel行数据哈希，用于去重                                    |
| version            | INT UNSIGNED    | 乐观锁版本控制                                               |
| created_at         | DATETIME        | 创建时间                                                     |
| updated_at         | DATETIME        | 更新时间（自动更新）                                         |

**索引策略**：

```
UNIQUE INDEX idx_uniq_no (asset_no),
INDEX idx_import_batch (import_batch),
INDEX idx_excel_row_hash (excel_row_hash),
INDEX idx_asset_uuid (asset_uuid),
INDEX idx_space_id (space_id),
INDEX idx_warranty_id (warranty_id),
INDEX idx_current_status (current_status)
```

**约束**：

```
CONSTRAINT fk_asset_space FOREIGN KEY (space_id) REFERENCES space_timeline(space_id),
CONSTRAINT fk_asset_warranty FOREIGN KEY (warranty_id) REFERENCES warranty_contract(warranty_id),
CONSTRAINT chk_current_status CHECK (current_status IN ('IN_USE','INVENTORY','MAINTENANCE','RETIRED'))
```

------

### **2. 分类元数据表 (category_metadata)**

| 字段名      | 类型            | 约束/说明                        |
| ----------- | --------------- | -------------------------------- |
| category_id | BIGINT UNSIGNED | 主键，自增                       |
| level       | TINYINT         | 分类层级（1-一级 2-二级 3-三级） |
| name        | VARCHAR(100)    | NOT NULL                         |
| code        | CHAR(4)         | 分类编码（例：IT01）             |
| parent_id   | BIGINT UNSIGNED | 父级分类（外键，自引用）         |
| created_at  | DATETIME        | 创建时间                         |
| updated_at  | DATETIME        | 更新时间                         |

**索引策略**：

```
INDEX idx_parent_id (parent_id)
```

**约束**：

```
CONSTRAINT fk_category_parent FOREIGN KEY (parent_id) REFERENCES category_metadata(category_id)
```

**数据示例**：

```
INSERT INTO category_metadata VALUES
(1,1,'IT设备','IT',NULL,'2023-01-01 00:00:00','2023-01-01 00:00:00'),
(3,2,'服务器','SV',1,'2023-01-01 00:00:00','2023-01-01 00:00:00'),
(5,3,'机架式','RK',3,'2023-01-01 00:00:00','2023-01-01 00:00:00');
```

**特性说明**：

- 采用自引用模式构建多级分类树
- 支持递归查询分类路径，便于获取完整分类体系

------

### **3. 空间轨迹表 (space_timeline)**

| 字段名        | 类型            | 约束/说明                                    |
| ------------- | --------------- | -------------------------------------------- |
| space_id      | BIGINT UNSIGNED | 主键，自增                                   |
| asset_id      | BIGINT UNSIGNED | 外键，关联asset_master表的asset_id           |
| location_path | VARCHAR(500)    | 位置全路径（华东数据中心/A机房/3排机柜/U12） |
| data_center   | VARCHAR(100)    | 数据中心                                     |
| room_name     | VARCHAR(100)    | 机房名称                                     |
| cabinet_no    | VARCHAR(50)     | 机柜编号                                     |
| u_position    | VARCHAR(20)     | U位编号                                      |
| environment   | VARCHAR(100)    | 使用环境                                     |
| keeper        | VARCHAR(50)     | 保管人                                       |
| is_current    | BOOLEAN         | 是否当前空间记录                             |
| valid_from    | DATETIME        | 生效时间                                     |
| valid_to      | DATETIME        | 失效时间（NULL表示当前有效）                 |
| created_at    | DATETIME        | 创建时间                                     |
| updated_at    | DATETIME        | 更新时间                                     |

**索引策略**：

```
INDEX idx_asset_id (asset_id),
INDEX idx_is_current (is_current),
INDEX idx_location (data_center, room_name),
INDEX idx_keeper (keeper)
```

**约束**：

```
CONSTRAINT fk_space_asset FOREIGN KEY (asset_id) REFERENCES asset_master(asset_id)
```

------

### **4. 用户表 (users)**

| 字段名                  | 类型         | 约束/说明                    |
| ----------------------- | ------------ | ---------------------------- |
| id                      | BIGINT       | 主键，自增                   |
| username                | VARCHAR(50)  | NOT NULL, UNIQUE, 用户登录名 |
| password                | VARCHAR(255) | NOT NULL, 加密后的密码       |
| real_name               | VARCHAR(50)  | 用户真实姓名                 |
| email                   | VARCHAR(100) | 电子邮件                     |
| phone                   | VARCHAR(20)  | 联系电话                     |
| avatar_url              | VARCHAR(255) | 头像URL                      |
| last_login_time         | DATETIME     | 最后登录时间                 |
| created_time            | DATETIME     | NOT NULL, 创建时间           |
| updated_time            | DATETIME     | 更新时间                     |
| enabled                 | BOOLEAN      | NOT NULL, 账号是否启用       |
| account_non_expired     | BOOLEAN      | NOT NULL, 账号是否未过期     |
| account_non_locked      | BOOLEAN      | NOT NULL, 账号是否未锁定     |
| credentials_non_expired | BOOLEAN      | NOT NULL, 凭证是否未过期     |

**索引策略**：

```
UNIQUE INDEX idx_username (username),
INDEX idx_email (email),
INDEX idx_phone (phone)
```

------

### **5. 用户角色表 (user_roles)**

| 字段名  | 类型         | 约束/说明             |
| ------- | ------------ | --------------------- |
| user_id | BIGINT       | 外键，关联users表的id |
| role    | VARCHAR(255) | 角色名称              |

**索引策略**：

```
INDEX idx_user_id (user_id)
```

**约束**：

```
CONSTRAINT fk_user_roles FOREIGN KEY (user_id) REFERENCES users(id)
```

------

### **6. 用户权限表 (user_permissions)**

| 字段名     | 类型         | 约束/说明             |
| ---------- | ------------ | --------------------- |
| user_id    | BIGINT       | 外键，关联users表的id |
| permission | VARCHAR(255) | 权限标识              |

**索引策略**：

```
INDEX idx_user_id (user_id)
```

**约束**：

```
CONSTRAINT fk_user_permissions FOREIGN KEY (user_id) REFERENCES users(id)
```

------

### **7. 维保合同表 (warranty_contract)**

| 字段名         | 类型            | 约束/说明                |
| -------------- | --------------- | ------------------------ |
| warranty_id    | BIGINT UNSIGNED | 主键，自增               |
| asset_id       | BIGINT UNSIGNED | 外键，关联asset_master表 |
| contract_no    | VARCHAR(50)     | 合同编号                 |
| provider       | VARCHAR(100)    | 维保提供商               |
| contact_person | VARCHAR(50)     | 联系人                   |
| contact_phone  | VARCHAR(20)     | 联系电话                 |
| warranty_level | VARCHAR(50)     | 维保级别                 |
| start_date     | DATE            | 维保开始日期             |
| end_date       | DATE            | 维保结束日期             |
| is_current     | BOOLEAN         | 是否当前有效维保         |
| created_at     | DATETIME        | 创建时间                 |
| updated_at     | DATETIME        | 更新时间                 |

**索引策略**：

```
INDEX idx_asset_id (asset_id),
INDEX idx_contract_no (contract_no),
INDEX idx_is_current (is_current)
```

**约束**：

```
CONSTRAINT fk_warranty_asset FOREIGN KEY (asset_id) REFERENCES asset_master(asset_id)
```