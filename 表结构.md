### 综合优化后的数据库设计方案

------

#### **总体设计原则**

1. **高内聚低耦合**：将频繁变更字段与核心属性分离
2. **历史追溯性**：完整记录资产全生命周期轨迹
3. **查询性能优先**：关键字段建立复合索引
4. **扩展性预留**：使用JSON字段应对未来字段变化

------

### **核心表结构设计**

#### **1. 资产主表 (asset_master)**

| 字段名             | 类型            | 约束/说明                                                    |
| ------------------ | --------------- | ------------------------------------------------------------ |
| asset_id           | BIGINT UNSIGNED | 主键，自增                                                   |
| asset_uuid         | CHAR(36)        | 业务唯一标识，生成规则: CONCAT('AST', DATE_FORMAT(NOW(), '%Y%m%d'), '-', UUID()) |
| asset_no           | VARCHAR(32)     | UNIQUE NOT NULL，资产编号规则: 分类码+部门码+年月+序列号     |
| asset_name         | VARCHAR(255)    | NOT NULL                                                     |
| current_status     | ENUM()          | 当前状态（使用中/库存/维修/报废）                            |
| category_hierarchy | JSON            | 存储分类路径 {"l1":1,"l2":3,"l3":5}                          |
| space_id           | BIGINT UNSIGNED | 当前空间位置（外键）                                         |
| warranty_id        | BIGINT UNSIGNED | 当前有效维保（外键）                                         |
| data_fingerprint   | CHAR(64)        | 数据指纹（SHA256哈希值）                                     |
| version            | INT UNSIGNED    | 乐观锁版本控制                                               |
| created_at         | DATETIME(6)     | 创建时间（微秒级精度）                                       |
| updated_at         | DATETIME(6)     | 更新时间（自动更新）                                         |

**索引策略**：

```sql
UNIQUE INDEX idx_uniq_no (asset_no),
INDEX idx_category ((CAST(category_hierarchy->'$.l1' AS UNSIGNED))),
SPATIAL INDEX idx_space (space_id)
```

------

#### **2. 分类元数据表 (category_metadata)**

| 字段名      | 类型            | 约束/说明                        |
| ----------- | --------------- | -------------------------------- |
| category_id | BIGINT UNSIGNED | 主键，自增                       |
| level       | TINYINT         | 分类层级（1-一级 2-二级 3-三级） |
| name        | VARCHAR(100)    | NOT NULL                         |
| code        | CHAR(4)         | 分类编码（例：IT01）             |
| parent_id   | BIGINT UNSIGNED | 父级分类（外键）                 |

**数据示例**：

```sql
INSERT INTO category_metadata VALUES
(1,1,'IT设备','IT',NULL),
(3,2,'服务器','SV',1),
(5,3,'机架式','RK',3);
```

------

#### **3. 空间轨迹表 (space_timeline)**

| 字段名        | 类型            | 约束/说明                                    |
| ------------- | --------------- | -------------------------------------------- |
| space_id      | BIGINT UNSIGNED | 主键，自增                                   |
| asset_id      | BIGINT UNSIGNED | 外键                                         |
| location_path | VARCHAR(500)    | 位置全路径（华东数据中心/A机房/3排机柜/U12） |
| coordinates   | POINT           | GIS坐标（用于地图展示）                      |
| valid_from    | DATETIME(6)     | 生效时间                                     |
| valid_to      | DATETIME(6)     | 失效时间（NULL表示当前有效）                 |

**空间索引**：

```sql
SPATIAL INDEX idx_coordinates (coordinates)
```

------

#### **4. 维保合约表 (warranty_contract)**

| 字段名         | 类型            | 约束/说明                              |
| -------------- | --------------- | -------------------------------------- |
| warranty_id    | BIGINT UNSIGNED | 主键，自增                             |
| asset_id       | BIGINT UNSIGNED | 外键                                   |
| contract_no    | VARCHAR(50)     | UNIQUE NOT NULL                        |
| time_range     | DATERANGE       | 维保期（PostgreSQL风格的时间范围类型） |
| provider_level | TINYINT         | 服务级别（1-基础 2-高级 3-专属）       |
| service_scope  | JSON            | 服务范围描述                           |

------

#### **5. 变更溯源表 (change_trace)**

| 字段名         | 类型            | 约束/说明                      |
| -------------- | --------------- | ------------------------------ |
| trace_id       | BIGINT UNSIGNED | 主键，自增                     |
| asset_id       | BIGINT UNSIGNED | 外键                           |
| change_type    | ENUM()          | 变更类型（位置/状态/维保等）   |
| delta_snapshot | JSON            | 变更差异快照（结构示例见下文） |
| operation_tree | JSON            | 操作链路（审批流程记录）       |

**差异快照示例**：

```json
{
  "field": "space",
  "before": {
    "data_center": "华东",
    "cabinet": "A-3",
    "u_position": 12
  },
  "after": {
    "data_center": "华北", 
    "cabinet": "B-5",
    "u_position": 8
  }
}
```

------

### **高级功能实现**

#### **1. 时空查询优化**

```sql
-- 查询指定机房的当前资产
SELECT * FROM asset_master
WHERE space_id IN (
  SELECT space_id FROM space_timeline
  WHERE location_path LIKE '%A机房%'
  AND valid_to IS NULL
);

-- 查找相邻U位的资产
SELECT a.* FROM asset_master a
JOIN space_timeline s1 ON a.space_id = s1.space_id
JOIN space_timeline s2 ON ST_Distance(s1.coordinates, s2.coordinates) < 10;
```

#### **2. 变更影响分析**

```sql
-- 统计最近7天各类型变更次数
SELECT 
  change_type,
  COUNT(*) AS total,
  JSON_EXTRACT(delta_snapshot, '$.field') AS field
FROM change_trace
WHERE operated_at >= NOW() - INTERVAL 7 DAY
GROUP BY change_type, field;
```

#### **3. 维保预警**

```sql
-- 提前30天预警维保到期
SELECT 
  a.asset_no,
  w.contract_no,
  UPPER(w.provider_level) AS level,
  w.time_range->>'end' AS end_date
FROM warranty_contract w
JOIN asset_master a ON w.asset_id = a.asset_id
WHERE w.time_range @> (CURRENT_DATE + INTERVAL 30 DAY);
```

------

### **性能优化策略**

1. **分区策略**：

   ```sql
   -- 按年分区空间轨迹表
   PARTITION BY RANGE (YEAR(valid_from)) (
     PARTITION p2023 VALUES LESS THAN (2024),
     PARTITION p2024 VALUES LESS THAN (2025)
   );
   ```

2. **混合索引**：

   ```sql
   -- 对JSON字段建立虚拟列索引
   ALTER TABLE asset_master
   ADD COLUMN l1_category INT 
   GENERATED ALWAYS AS (category_hierarchy->>'$.l1'),
   
   ADD INDEX idx_l1 (l1_category);
   ```

3. **缓存加速**：

   ```sql
   -- 创建汇总物化视图
   CREATE MATERIALIZED VIEW asset_stats
   AS
   SELECT 
     c.name AS category,
     COUNT(*) FILTER (WHERE status='active') AS active,
     COUNT(*) FILTER (WHERE status='retired') AS retired
   FROM asset_master a
   JOIN category_metadata c ON a.l1_category = c.category_id
   GROUP BY c.name;
   ```

------

### **数据治理方案**

1. **生命周期管理**：

   ```mermaid
   graph LR
     A[新资产] --> B{使用中}
     B -->|维保到期| C[预警状态]
     B -->|故障| D[维修状态]
     C -->|续保| B
     C -->|未处理| E[停用状态]
     E --> F[报废流程]
   ```

2. **数据质量监控**：

   ```sql
   -- 查找哈希值不一致的记录
   SELECT asset_id 
   FROM asset_master
   WHERE data_fingerprint != SHA2(CONCAT(
     asset_no, asset_name, current_status
   ), 256);
   ```

3. **自动归档策略**：

   ```sql
   -- 将5年前数据归档
   INSERT INTO asset_archive
   SELECT * FROM asset_master
   WHERE created_at < NOW() - INTERVAL 5 YEAR;
   
   DELETE FROM asset_master
   WHERE created_at < NOW() - INTERVAL 5 YEAR;
   ```

------

该方案通过精细化分表设计，在保证OLTP性能的同时满足OLAP分析需求，完整覆盖Excel原始字段，并通过以下创新点提升管理效率：

1. **智能编码体系**：资产编号嵌入分类和时空信息
2. **时空耦合建模**：GIS坐标与逻辑位置双重管理
3. **版本快照技术**：毫秒级精度的时间轴追溯
4. **混合索引策略**：B+Tree与空间索引联合加速
5. **动态分级预警**：多级维保状态智能预测

具体实施时可结合InnoDB Cluster实现高可用，利用MySQL Shell进行自动化部署。